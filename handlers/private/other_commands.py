from aiogram import types
from aiogram.dispatcher.filters import Command, CommandStart
from aiogram.utils.exceptions import CantParseEntities

from loader import dp, db
from utils.pages.rating import page_rating, page_top_users
from utils.throttlig import rate_limit


@rate_limit(limit=3)
@dp.message_handler(Command('help'))
async def command_help(message: types.Message):
    text = f'‚ùî<b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º</b>‚ùî\n\n' \
           f'–í—Å—ë –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ, –Ω–∞–ø–∏—à–∏ –±–æ—Ç—É –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏ –±–æ—Ç –≤—ã–¥–∞—Å—Ç —Ç–µ–±–µ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–Ω–∏–≥–∏\n' \
           f'–õ–∏–±–æ —Ç—ã –º–æ–∂–µ—à—å –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º –ø–æ–∏—Å–∫–æ–º, —Å –ø–æ–º–æ—â—å—é —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–º–∞–Ω–¥: üëá\n\n' \
           f'/start - —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞, —á—Ç–æ–±—ã –≤–ø–µ—Ä–≤—ã–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n' \
           f'/author <i>–∏–º—è –∞–≤—Ç–æ—Ä–∞</i> - –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –ø–æ –∞–≤—Ç–æ—Ä–∞–º\n' \
           f'/series <i>–Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏</i> - –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Å–µ—Ä–∏–∏\n' \
           f'/create_post - –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–≤–æ–π –ø–æ—Å—Ç –≤ –Ω–∞—à–µ–º –∫–∞–Ω–∞–ª–µ @books_bar' \
           f'/rating_b - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¢–û–ü 10 –∫–Ω–∏–≥ –ø–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è–º\n' \
           f'/rating_a - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¢–û–ü 10 –∞–≤—Ç–æ—Ä–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º\n' \
           f'/help - –≤—ã–∑–æ–≤ —Å–ø—Ä–∞–≤–∫–∏, –µ—Å–ª–∏ —Ç—ã –∑–∞–±—ã–ª –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–ºüôÉ\n\n' \
           f'‚ùî <b>–ö–∞–∫ –∏—Å–∫–∞—Ç—å –∫–Ω–∏–≥–∏</b> ‚ùî\n\n' \
           f'–ß—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é –∫–Ω–∏–≥—É, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –µ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ\n' \
           f'–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ! –¢–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –±–µ–∑ –§–ò–û –∞–≤—Ç–æ—Ä–∞\n' \
           f'–¢–∞–∫–∂–µ —Ç—ã –º–æ–∂–µ—à—å –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ—á–Ω—ã–º –ø–æ–∏—Å–∫–æ–º üëá\n\n' \
           f'–ü—Ä–∏–º–µ—Ä—ã —Ç–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:\n' \
           f'/author –î–∂–æ–∞–Ω –†–æ—É–ª–∏–Ω–≥\n' \
           f'/author –ü—É—à–∫–∏–Ω\n' \
           f'/series –ø–µ—Å–Ω—å –ª—å–¥–∞ –∏ –ø–ª–∞–º–µ–Ω–∏\n' \
           f'/series –ì–æ–ª–æ–¥–Ω—ã–µ –ò–≥—Ä—ã\n\n' \
           f'‚ùó–ï—Å–ª–∏ –≤—ã –∑–∞–º–µ—Ç–∏–ª–∏ –æ—à–∏–±–∫—É –≤ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞,\n' \
           f'‚ùó–õ–∏–±–æ —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–æ—Ç–∞\n' \
           f'–ù–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º üëá\n' \
           f'<pre>!message <i>–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</i></pre>\n\n' \
           f'<b>P.S.</b>\n' \
           f'–ö–Ω–∏–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤–æ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è\n' \
           f'–ú–æ—è –≥—Ä—É–ø–ø–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π: @free_book_flibusta\n' \
           f'–ö–Ω–∏–∂–Ω—ã–π –±–∞—Ä: @books_bar üìö\n' \
           f'–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ª–∏—á–Ω–æ–π –≥—Ä—É–ø–ø—ã: /create_group' \

    await message.answer(text)


@rate_limit(limit=3)
@dp.message_handler(CommandStart())
async def command_start(message: types.Message):

    from handlers.users.chosen_links import chosen_link_book

    if message.get_args():      # –Æ–∑–µ—Ä –ø—Ä–∏—à–µ–ª —Å –∫–∞–Ω–∞–ª–∞, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É "—Å–∫–∞—á–∞—Ç—å"
        return await chosen_link_book(message)

    text = f'–ü—Ä–∏–≤–µ—Ç, {message.from_user.full_name}! \n\n' \
           f'–Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ —Ç–µ–±–µ –ª—é–±—É—é –∫–Ω–∏–≥—É!üòá\n' \
           f'–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –ø—Ä–∏—à–ª–∏ –º–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ üìñ\n\n' \
           f'–Ø —Ç–∞–∫–∂–µ –º–æ–≥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –ø–æ–∏—Å–∫ –ø–æ –§–ò–û –∞–≤—Ç–æ—Ä–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–Ω–∏–∂–Ω–æ–π —Å–µ—Ä–∏–∏ ‚ò∫\n' \
           f'–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ üôè –ø—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å –∏—Å–∫–∞—Ç—å, –æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å —Å–ø—Ä–∞–≤–∫–æ–π üëâ /help\n\n' \
           f'‚ùó –í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ‚ùó\n' \
           f'‚ö†–ï—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–æ—Ç–∞ –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π –ø—Ä–∞–≤ –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª–µ–π‚ö†\n' \
           f'–ü–æ—ç—Ç–æ–º—É –º–Ω–æ–≥–∏–µ –∫–Ω–∏–≥–∏, –∞–≤—Ç–æ—Ä—ã, –∫–Ω–∏–∂–Ω—ã–µ —Å–µ—Ä–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã üòû\n\n' \
           f'‚ùï <b>–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–∞—Ö</b>‚ùï\n' \
           f'@free_book_flibusta - –º–æ—è –≥—Ä—É–ø–ø–∞, –≥–¥–µ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π\n' \
           f'@books_bar - –∫–Ω–∏–∂–Ω—ã–π –±–∞—Ä üìö'

    try:
        await message.answer(text)
    except CantParseEntities:               # –û—à–∏–±–∫–∞, –µ—Å–ª–∏ —É —é–∑–µ—Ä–∞ –Ω–∏–∫–Ω–µ–π–º –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä–Ω—ã–π
        pass
    await db.add_user(user=message.from_user.full_name, telegram_id=message.from_user.id)



@rate_limit(limit=3)
@dp.message_handler(Command('create_group'))
async def create_user_group(message: types.Message):
    text = '''
    ‚ö† –°—É—â–µ—Å—Ç–≤—É–µ—Ç –±–æ–ª—å—à–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–æ—Ç–∞ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤ ‚ö†
–ß—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—Å—è –∏ –¥–∞–ª—å—à–µ —É—Å–ª—É–≥–∞–º–∏ –±–æ—Ç–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω üìµ
–°–ª–µ–¥—É–π—Ç–µ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∏–∂–µ:\n

1. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
- 1.1 —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –≥—Ä—É–ø–ø—É (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–∞ <a href="http://telegram.org.ru/374-kak-sozdat-gruppu-ili-kanal-v-telegram.html#hmenu-2">—Å–∞–π—Ç–µ —Ç–µ–ª–µ–≥—Ä–∞–º</>)
- 1.2 –¥–æ–±–∞–≤—å—Ç–µ –≤ –≥—Ä—É–ø–ø—É –±–æ—Ç–∞ –ø–æ [<a href="https://t.me/my_flibusta_bot?startgroup=1">—ç—Ç–æ–π —Å—Å—ã–ª–∫–µ</a>]
- 1.3 –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã"
- 1.4 –ù–∞–∂–º–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞ \n
–ì–æ—Ç–æ–≤–æ! –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø–æ–∏—Å–∫–∏ –ª—é–±–∏–º—ã—Ö –∫–Ω–∏–≥ üìö

–î–ª—è Android –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –∏–∑ <a href="http://telegram.org/android" >–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞</a> –±–µ–∑ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

    '''
    return await message.answer(text)


@rate_limit(limit=3)
@dp.message_handler(Command('rating_b'))
async def rating_top_book(message: types.Message):
    # –í—ã–≤–æ–¥–∏—Ç —Ç–æ–ø 10 –∫–Ω–∏–≥ –ø–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è–º
    rating_dict = await db.rating_top_10_values('book')
    descr = f'–¢–û–ü 10 –ö–ù–ò–ì'
    text = page_rating(rating_dict, descr=descr)
    await message.answer(text)
    await db.top_users()


@rate_limit(limit=3)
@dp.message_handler(Command('rating_a'))
async def rating_top_book(message: types.Message):
    # –í—ã–≤–æ–¥–∏—Ç —Ç–æ–ø 10 –∞–≤—Ç–æ—Ä–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º
    rating_dict = await db.rating_top_10_values('author')
    descr = f'–¢–û–ü 10 –ê–í–¢–û–†–û–í'
    text = page_rating(rating_dict, descr=descr)
    await message.answer(text)


@dp.message_handler(Command('rating_u'))
async def rating_user(message: types.Message):
    data = await db.top_users()
    users_dict = {d.get('full_name'): d.get('amount') for d in data}
    ended_list = page_top_users(users_dict)
    await message.answer(ended_list)